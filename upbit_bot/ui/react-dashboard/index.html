<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Upbit Bot React Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@tanstack/react-query@4.36.1/build/umd/index.production.min.js"></script>
  </head>
  <body class="bg-slate-900 text-white">
    <div id="root" class="max-w-6xl mx-auto p-6"></div>
    <script type="text/javascript">
      const { useState, useEffect } = React;
      const { QueryClient, QueryClientProvider, useQuery, useMutation } = ReactQuery;
      const client = new QueryClient();
      const API = "http://localhost:8000";

      function useFetch(path) {
        return useQuery([path], async () => {
          const res = await fetch(API + path);
          return res.json();
        }, { refetchInterval: 3000 });
      }

      function MetricCard({ title, value }) {
        return (
          <div className="bg-slate-800 p-4 rounded">
            <div className="text-gray-400 text-sm">{title}</div>
            <div className="text-2xl font-semibold">{value ?? '-'}</div>
          </div>
        );
      }

      function Dashboard() {
        const account = useFetch("/account");
        const orders = useFetch("/orders");
        const pnl = useFetch("/pnl");
        const heatmap = useFetch("/heatmap");
        const [wsProfit, setWsProfit] = useState(null);

        useEffect(() => {
          const ws = new WebSocket(API.replace("http", "ws") + "/ws/stream");
          ws.onmessage = (ev) => {
            const msg = JSON.parse(ev.data);
            if (msg.type === "snapshot" && msg.data) setWsProfit(msg.data.profit_pct);
          };
          return () => ws.close();
        }, []);

        const snap = account.data?.snapshot;
        return (
          <div className="space-y-4">
            <div className="grid grid-cols-3 gap-4">
              <MetricCard title="KRW" value={snap ? snap.krw_balance.toLocaleString() : '-'} />
              <MetricCard title="Total Value" value={snap ? snap.total_value.toLocaleString() : '-'} />
              <MetricCard title="Profit %" value={wsProfit ?? (snap ? snap.profit_pct.toFixed(2) + '%' : '-')} />
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div className="bg-slate-800 p-4 rounded col-span-2">
                <h3 className="font-semibold mb-2">Holdings</h3>
                <table className="w-full text-sm">
                  <thead><tr><th className="text-left">Market</th><th>Qty</th><th>Avg</th><th>Est KRW</th></tr></thead>
                  <tbody>
                    {snap?.holdings?.map((h) => (
                      <tr key={h.market}><td>{h.market}</td><td>{h.balance}</td><td>{h.avg_buy_price}</td><td>{h.estimated_krw.toLocaleString()}</td></tr>
                    )) || null}
                  </tbody>
                </table>
              </div>
              <div className="bg-slate-800 p-4 rounded">
                <h3 className="font-semibold mb-2">Equity</h3>
                <div className="text-xs space-y-1 max-h-64 overflow-auto">
                  {pnl.data?.equity_curve?.slice(-20).map((p, i) => (
                    <div key={i} className="flex justify-between text-gray-300">
                      <span>{p.captured_at}</span><span>{p.total_value.toFixed(0)}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="bg-slate-800 p-4 rounded">
              <h3 className="font-semibold mb-2">Heatmap</h3>
              <div className="grid grid-cols-4 gap-2">
                {heatmap.data?.heatmap?.map((h, i) => (
                  <div key={i} className="p-2 rounded bg-slate-700">
                    <div className="text-sm">{h.market}</div>
                    <div className="text-xs text-gray-300">Score {(h.composite*100).toFixed(1)}</div>
                    <div className="text-xs text-gray-400">Trend {(h.trend*100).toFixed(1)}</div>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-slate-800 p-4 rounded">
              <h3 className="font-semibold mb-2">Orders</h3>
              <table className="w-full text-sm">
                <thead><tr><th>Market</th><th>Side</th><th>Price</th><th>Vol</th><th>Status</th></tr></thead>
                <tbody>
                  {orders.data?.orders?.map((o, i) => (
                    <tr key={i}><td>{o.market}</td><td>{o.side}</td><td>{o.price}</td><td>{o.volume}</td><td>{o.status}</td></tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        <QueryClientProvider client={client}>
          <Dashboard />
        </QueryClientProvider>
      );
    </script>
  </body>
</html>
